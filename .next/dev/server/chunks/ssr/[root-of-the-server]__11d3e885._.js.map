{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 26, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/lib/db.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nlet pool: Pool | null = null;\n\nfunction getPool() {\n  if (!pool) {\n    pool = new Pool({\n      connectionString: process.env.DATABASE_URL,\n      ssl: {\n        rejectUnauthorized: false,\n      },\n    });\n  }\n  return pool;\n}\n\nexport async function query<T = any>(\n  text: string,\n  params?: any[]\n): Promise<{ rows: T[] }> {\n  const p = getPool();\n  const res = await p.query(text, params);\n  return res as any;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,OAAoB;AAExB,SAAS;IACP,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd,kBAAkB,QAAQ,GAAG,CAAC,YAAY;YAC1C,KAAK;gBACH,oBAAoB;YACtB;QACF;IACF;IACA,OAAO;AACT;AAEO,eAAe,MACpB,IAAY,EACZ,MAAc;IAEd,MAAM,IAAI;IACV,MAAM,MAAM,MAAM,EAAE,KAAK,CAAC,MAAM;IAChC,OAAO;AACT","debugId":null}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/lib/session.ts"],"sourcesContent":["// ‚úÖ Hanya untuk SERVER COMPONENT\nimport \"server-only\";\nimport { cookies } from \"next/headers\";\nimport { randomUUID } from \"crypto\";\nimport { query } from \"./db\";\n\nconst COOKIE = process.env.SESSION_COOKIE_NAME || \"padsi_session\";\n\n/**\n * Membuat sesi login baru\n */\nexport async function createSession(userId: number) {\n  const sid = randomUUID();\n  const exp = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000); // 7 hari\n\n  await query(\n    \"INSERT INTO sessions (session_id, user_id, expires_at) VALUES ($1, $2, $3)\",\n    [sid, userId, exp]\n  );\n\n  // ‚úÖ Sekarang cookies() harus di-await\n  const cookieStore = await cookies();\n  cookieStore.set(COOKIE, sid, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    path: \"/\",\n    secure: true,\n    expires: exp,\n  });\n}\n\n/**\n * Menghapus sesi login (logout)\n */\nexport async function destroySession() {\n  const cookieStore = await cookies();\n  const c = cookieStore.get(COOKIE);\n  if (c?.value) {\n    await query(\"DELETE FROM sessions WHERE session_id = $1\", [c.value]);\n    cookieStore.delete(COOKIE);\n  }\n}\n\n/**\n * Mendapatkan data user dari sesi aktif\n */\nexport async function getSessionUser() {\n  const cookieStore = await cookies();\n  const c = cookieStore.get(COOKIE);\n  if (!c?.value) return null;\n\n  const { rows } = await query(\n    `\n    SELECT u.id, u.email, u.name, u.role\n    FROM sessions s\n    JOIN users u ON u.id = s.user_id\n    WHERE s.session_id = $1\n      AND s.expires_at > NOW()\n  `,\n    [c.value]\n  );\n\n  return rows[0] || null;\n}\n\n/**\n * Mengecek apakah user punya role tertentu\n */\nexport async function requireRole(roles: (\"OWNER\" | \"PEGAWAI\")[]) {\n  const user = await getSessionUser();\n  if (!user) return { ok: false as const, user: null };\n  if (!roles.includes(user.role)) return { ok: false as const, user };\n  return { ok: true as const, user };\n}\n"],"names":[],"mappings":"AAAA,iCAAiC;;;;;;;;;;;AACjC;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AAK3C,eAAe,cAAc,MAAc;IAChD,MAAM,MAAM,IAAA,mHAAU;IACtB,MAAM,MAAM,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK,KAAK,KAAK,OAAO,SAAS;IAErE,MAAM,IAAA,yHAAK,EACT,8EACA;QAAC;QAAK;QAAQ;KAAI;IAGpB,sCAAsC;IACtC,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,YAAY,GAAG,CAAC,QAAQ,KAAK;QAC3B,UAAU;QACV,UAAU;QACV,MAAM;QACN,QAAQ;QACR,SAAS;IACX;AACF;AAKO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,MAAM,IAAI,YAAY,GAAG,CAAC;IAC1B,IAAI,GAAG,OAAO;QACZ,MAAM,IAAA,yHAAK,EAAC,8CAA8C;YAAC,EAAE,KAAK;SAAC;QACnE,YAAY,MAAM,CAAC;IACrB;AACF;AAKO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,0IAAO;IACjC,MAAM,IAAI,YAAY,GAAG,CAAC;IAC1B,IAAI,CAAC,GAAG,OAAO,OAAO;IAEtB,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,IAAA,yHAAK,EAC1B,CAAC;;;;;;EAMH,CAAC,EACC;QAAC,EAAE,KAAK;KAAC;IAGX,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAKO,eAAe,YAAY,KAA8B;IAC9D,MAAM,OAAO,MAAM;IACnB,IAAI,CAAC,MAAM,OAAO;QAAE,IAAI;QAAgB,MAAM;IAAK;IACnD,IAAI,CAAC,MAAM,QAAQ,CAAC,KAAK,IAAI,GAAG,OAAO;QAAE,IAAI;QAAgB;IAAK;IAClE,OAAO;QAAE,IAAI;QAAe;IAAK;AACnC","debugId":null}},
    {"offset": {"line": 135, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/components/ShellClient.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/ShellClient.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/ShellClient.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAAkS,GAC/T,gEACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 149, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/components/ShellClient.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/ShellClient.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/ShellClient.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAA8Q,GAC3S,4CACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 163, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 171, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/components/Shell.tsx"],"sourcesContent":["// src/components/Shell.tsx\nimport { getSessionUser } from \"@/lib/session\";\nimport ShellClient from \"./ShellClient\";\n\nexport default async function Shell({ children }: { children: React.ReactNode }) {\n  const user = await getSessionUser(); // Hanya Server Component yang boleh\n  return <ShellClient user={user}>{children}</ShellClient>;\n}\n"],"names":[],"mappings":"AAAA,2BAA2B;;;;;;AAC3B;AACA;;;;AAEe,eAAe,MAAM,EAAE,QAAQ,EAAiC;IAC7E,MAAM,OAAO,MAAM,IAAA,uIAAc,KAAI,oCAAoC;IACzE,qBAAO,8OAAC,4IAAW;QAAC,MAAM;kBAAO;;;;;;AACnC","debugId":null}},
    {"offset": {"line": 197, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/app/riwayat/page.tsx"],"sourcesContent":["import Shell from \"@/components/Shell\";\nimport { requireRole } from \"@/lib/session\";\nimport { query } from \"@/lib/db\";\nimport { Trash2, Upload } from \"lucide-react\";\n\nexport const dynamic = \"force-dynamic\";\n\nexport default async function RiwayatPage(props: {\n  searchParams: Promise<{ q?: string }>;\n}) {\n  const { searchParams } = props;\n  const sp = await searchParams; // ‚úÖ Next.js 16: harus di-await\n  const can = await requireRole([\"OWNER\", \"PEGAWAI\"]);\n\n  if (!can.ok)\n    return (\n      <div className=\"p-6\">\n        Silakan{\" \"}\n        <a className=\"text-blue-600 underline\" href=\"/login\">\n          login\n        </a>\n        .\n      </div>\n    );\n\n  // ‚úÖ Ambil kata kunci dari URL (?q=...)\n  const keyword = sp?.q ? `%${sp.q}%` : \"%%\";\n\n  // ‚úÖ Query database dengan filter nama pelanggan\n  const { rows: visits } = await query(\n    `\n    SELECT v.*, c.name as customer_name\n    FROM visits v\n    JOIN customers c ON c.id = v.customer_id\n    WHERE c.name ILIKE $1\n    ORDER BY visited_at DESC\n  `,\n    [keyword]\n  );\n\n  return (\n    <Shell>\n      <h1 className=\"text-xl font-semibold mb-4\">Riwayat Kunjungan</h1>\n\n      {/* üîÅ Bar atas: Import + Cari */}\n      <div className=\"flex flex-wrap gap-3 items-center mb-4\">\n        {/* üîΩ Form Impor File dari POS */}\n        <form\n          action=\"/api/visits/import\"\n          method=\"post\"\n          encType=\"multipart/form-data\"\n          className=\"flex items-center gap-2 bg-white px-3 py-2 rounded-lg shadow border border-gray-200\"\n        >\n          <label className=\"text-sm text-gray-700 font-medium\">\n            Impor riwayat (CSV/JSON)\n          </label>\n          <input\n            type=\"file\"\n            name=\"file\"\n            accept=\".csv,.json\"\n            required\n            className=\"text-xs\"\n          />\n          <button\n            type=\"submit\"\n            className=\"flex items-center gap-1 bg-[#e31c1c] text-white text-xs px-3 py-1.5 rounded hover:bg-red-700 transition\"\n          >\n            <Upload size={14} />\n            Impor\n          </button>\n        </form>\n\n        {/* üîç Form Pencarian (tetap) */}\n        <form method=\"get\" className=\"flex gap-2\">\n          <input\n            type=\"text\"\n            name=\"q\"\n            placeholder=\"Cari nama pelanggan...\"\n            defaultValue={sp?.q || \"\"}\n            className=\"border rounded p-2 w-64 text-sm\"\n          />\n          <button\n            type=\"submit\"\n            className=\"bg-blue-600 text-white px-3 rounded hover:bg-blue-700 text-sm\"\n          >\n            Cari\n          </button>\n        </form>\n      </div>\n\n      {/* üßæ Tabel Riwayat (TIDAK diubah strukturnya) */}\n      <div className=\"overflow-auto rounded-xl bg-white shadow\">\n        <table className=\"w-full text-sm\">\n          <thead className=\"bg-gray-50\">\n            <tr>\n              <th className=\"p-3 text-left\">Tanggal</th>\n              <th className=\"p-3 text-left\">Pelanggan</th>\n              <th className=\"p-3 text-right\">Belanja</th>\n              <th className=\"p-3 text-right\">Poin</th>\n              <th className=\"p-3\">Aksi</th>\n            </tr>\n          </thead>\n          <tbody>\n            {visits.map((v: any) => (\n              <tr key={v.id} className=\"border-t\">\n                <td className=\"p-3\">\n                  {new Date(v.visited_at).toISOString().slice(0, 10)}\n                </td>\n                <td className=\"p-3\">{v.customer_name}</td>\n                <td className=\"p-3 text-right\">Rp {v.total_spend}</td>\n                <td className=\"p-3 text-right\">{v.earned_pts}</td>\n                <td className=\"p-3 text-center\">\n                  <form\n                    action={`/api/visits/${v.id}`}\n                    method=\"post\"\n                    className=\"flex justify-center\"\n                  >\n                    <input type=\"hidden\" name=\"_method\" value=\"DELETE\" />\n                    <button\n                      title=\"Hapus\"\n                      className=\"text-red-600 hover:text-red-800 transition\"\n                    >\n                      <Trash2 size={18} />\n                    </button>\n                  </form>\n                </td>\n              </tr>\n            ))}\n\n            {visits.length === 0 && (\n              <tr>\n                <td\n                  className=\"p-4 text-center text-gray-500\"\n                  colSpan={5}\n                >\n                  Belum ada riwayat kunjungan.\n                </td>\n              </tr>\n            )}\n          </tbody>\n        </table>\n      </div>\n    </Shell>\n  );\n}\n"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;AACA;AAAA;;;;;;AAEO,MAAM,UAAU;AAER,eAAe,YAAY,KAEzC;IACC,MAAM,EAAE,YAAY,EAAE,GAAG;IACzB,MAAM,KAAK,MAAM,cAAc,+BAA+B;IAC9D,MAAM,MAAM,MAAM,IAAA,oIAAW,EAAC;QAAC;QAAS;KAAU;IAElD,IAAI,CAAC,IAAI,EAAE,EACT,qBACE,8OAAC;QAAI,WAAU;;YAAM;YACX;0BACR,8OAAC;gBAAE,WAAU;gBAA0B,MAAK;0BAAS;;;;;;YAEjD;;;;;;;IAKV,uCAAuC;IACvC,MAAM,UAAU,IAAI,IAAI,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG;IAEtC,gDAAgD;IAChD,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,IAAA,yHAAK,EAClC,CAAC;;;;;;EAMH,CAAC,EACC;QAAC;KAAQ;IAGX,qBACE,8OAAC,sIAAK;;0BACJ,8OAAC;gBAAG,WAAU;0BAA6B;;;;;;0BAG3C,8OAAC;gBAAI,WAAU;;kCAEb,8OAAC;wBACC,QAAO;wBACP,QAAO;wBACP,SAAQ;wBACR,WAAU;;0CAEV,8OAAC;gCAAM,WAAU;0CAAoC;;;;;;0CAGrD,8OAAC;gCACC,MAAK;gCACL,MAAK;gCACL,QAAO;gCACP,QAAQ;gCACR,WAAU;;;;;;0CAEZ,8OAAC;gCACC,MAAK;gCACL,WAAU;;kDAEV,8OAAC,gNAAM;wCAAC,MAAM;;;;;;oCAAM;;;;;;;;;;;;;kCAMxB,8OAAC;wBAAK,QAAO;wBAAM,WAAU;;0CAC3B,8OAAC;gCACC,MAAK;gCACL,MAAK;gCACL,aAAY;gCACZ,cAAc,IAAI,KAAK;gCACvB,WAAU;;;;;;0CAEZ,8OAAC;gCACC,MAAK;gCACL,WAAU;0CACX;;;;;;;;;;;;;;;;;;0BAOL,8OAAC;gBAAI,WAAU;0BACb,cAAA,8OAAC;oBAAM,WAAU;;sCACf,8OAAC;4BAAM,WAAU;sCACf,cAAA,8OAAC;;kDACC,8OAAC;wCAAG,WAAU;kDAAgB;;;;;;kDAC9B,8OAAC;wCAAG,WAAU;kDAAgB;;;;;;kDAC9B,8OAAC;wCAAG,WAAU;kDAAiB;;;;;;kDAC/B,8OAAC;wCAAG,WAAU;kDAAiB;;;;;;kDAC/B,8OAAC;wCAAG,WAAU;kDAAM;;;;;;;;;;;;;;;;;sCAGxB,8OAAC;;gCACE,OAAO,GAAG,CAAC,CAAC,kBACX,8OAAC;wCAAc,WAAU;;0DACvB,8OAAC;gDAAG,WAAU;0DACX,IAAI,KAAK,EAAE,UAAU,EAAE,WAAW,GAAG,KAAK,CAAC,GAAG;;;;;;0DAEjD,8OAAC;gDAAG,WAAU;0DAAO,EAAE,aAAa;;;;;;0DACpC,8OAAC;gDAAG,WAAU;;oDAAiB;oDAAI,EAAE,WAAW;;;;;;;0DAChD,8OAAC;gDAAG,WAAU;0DAAkB,EAAE,UAAU;;;;;;0DAC5C,8OAAC;gDAAG,WAAU;0DACZ,cAAA,8OAAC;oDACC,QAAQ,CAAC,YAAY,EAAE,EAAE,EAAE,EAAE;oDAC7B,QAAO;oDACP,WAAU;;sEAEV,8OAAC;4DAAM,MAAK;4DAAS,MAAK;4DAAU,OAAM;;;;;;sEAC1C,8OAAC;4DACC,OAAM;4DACN,WAAU;sEAEV,cAAA,8OAAC,oNAAM;gEAAC,MAAM;;;;;;;;;;;;;;;;;;;;;;;uCAlBb,EAAE,EAAE;;;;;gCAyBd,OAAO,MAAM,KAAK,mBACjB,8OAAC;8CACC,cAAA,8OAAC;wCACC,WAAU;wCACV,SAAS;kDACV;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAUjB","debugId":null}}]
}