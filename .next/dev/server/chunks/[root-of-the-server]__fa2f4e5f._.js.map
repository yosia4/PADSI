{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/lib/db.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nlet pool: Pool | null = null;\nconst RETRYABLE_PG_CODES = new Set([\n  \"ETIMEDOUT\",\n  \"ECONNRESET\",\n  \"ECONNREFUSED\",\n  \"57P01\", // admin shutdown\n  \"57P02\", // crash\n  \"57P03\", // cannot connect now\n  \"08006\", // connection failure\n]);\n\nfunction getPool() {\n  if (!pool) {\n    pool = new Pool({\n      connectionString: process.env.DATABASE_URL,\n      ssl:\n        process.env.NODE_ENV === \"production\"\n          ? {\n              rejectUnauthorized: false,\n            }\n          : undefined,\n      connectionTimeoutMillis: 10_000,\n      idleTimeoutMillis: 10_000,\n      max: parseInt(process.env.PG_POOL_SIZE || \"10\", 10),\n      keepAlive: true,\n    });\n  }\n  return pool;\n}\n\nexport async function query<T = any>(\n  text: string,\n  params?: any[]\n): Promise<{ rows: T[] }> {\n  const p = getPool();\n  let lastError: any = null;\n  for (let attempt = 1; attempt <= 4; attempt++) {\n    try {\n      const res = await p.query(text, params);\n      return res as any;\n    } catch (error: any) {\n      lastError = error;\n      const retryable =\n        RETRYABLE_PG_CODES.has(error?.code) ||\n        error?.message?.includes(\"Connection terminated\");\n      if (!retryable || attempt === 3) {\n        error.message = `Database query failed after ${attempt} attempt(s): ${error.message}`;\n        throw error;\n      }\n      await new Promise((resolve) => setTimeout(resolve, attempt * 400));\n    }\n  }\n  throw lastError;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,OAAoB;AACxB,MAAM,qBAAqB,IAAI,IAAI;IACjC;IACA;IACA;IACA;IACA;IACA;IACA;CACD;AAED,SAAS;IACP,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd,kBAAkB,QAAQ,GAAG,CAAC,YAAY;YAC1C,KACE,sCACI,0BAGA;YACN,yBAAyB;YACzB,mBAAmB;YACnB,KAAK,SAAS,QAAQ,GAAG,CAAC,YAAY,IAAI,MAAM;YAChD,WAAW;QACb;IACF;IACA,OAAO;AACT;AAEO,eAAe,MACpB,IAAY,EACZ,MAAc;IAEd,MAAM,IAAI;IACV,IAAI,YAAiB;IACrB,IAAK,IAAI,UAAU,GAAG,WAAW,GAAG,UAAW;QAC7C,IAAI;YACF,MAAM,MAAM,MAAM,EAAE,KAAK,CAAC,MAAM;YAChC,OAAO;QACT,EAAE,OAAO,OAAY;YACnB,YAAY;YACZ,MAAM,YACJ,mBAAmB,GAAG,CAAC,OAAO,SAC9B,OAAO,SAAS,SAAS;YAC3B,IAAI,CAAC,aAAa,YAAY,GAAG;gBAC/B,MAAM,OAAO,GAAG,CAAC,4BAA4B,EAAE,QAAQ,aAAa,EAAE,MAAM,OAAO,EAAE;gBACrF,MAAM;YACR;YACA,MAAM,IAAI,QAAQ,CAAC,UAAY,WAAW,SAAS,UAAU;QAC/D;IACF;IACA,MAAM;AACR","debugId":null}},
    {"offset": {"line": 104, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/app/api/customers/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { query } from \"@/lib/db\";\n\nconst expectsJson = (req: NextRequest) =>\n  req.headers.get(\"x-requested-with\") === \"fetch\";\n\nexport async function POST(req: NextRequest) {\n  const form = await req.formData();\n  const name = String(form.get(\"name\") || \"\").trim();\n  const email = form.get(\"email\")\n    ? String(form.get(\"email\")).trim() || null\n    : null;\n  const phone = form.get(\"phone\")\n    ? String(form.get(\"phone\")).trim() || null\n    : null;\n\n  if (!name) {\n    const message = \"Nama pelanggan wajib diisi.\";\n    if (expectsJson(req)) {\n      return NextResponse.json({ error: message, field: \"name\" }, { status: 400 });\n    }\n    const redirectUrl = new URL(\"/pelanggan?error=name_required\", req.url);\n    return NextResponse.redirect(redirectUrl);\n  }\n\n  if (email && !email.includes(\"@\")) {\n    const message = \"Alamat email harus valid.\";\n    if (expectsJson(req)) {\n      return NextResponse.json({ error: message, field: \"email\" }, { status: 400 });\n    }\n    const redirectUrl = new URL(\"/pelanggan?error=email_invalid\", req.url);\n    return NextResponse.redirect(redirectUrl);\n  }\n\n  if (phone) {\n    const { rows: dup } = await query(\n      \"SELECT id FROM customers WHERE phone = $1 LIMIT 1\",\n      [phone]\n    );\n    if (dup.length > 0) {\n      const message = \"Nomor telepon sudah terdaftar.\";\n    if (expectsJson(req)) {\n      return NextResponse.json({ error: message, field: \"phone\" }, { status: 400 });\n    }\n      const redirectUrl = new URL(\n        \"/pelanggan?error=phone_taken\",\n        req.url\n      );\n      return NextResponse.redirect(redirectUrl);\n    }\n  }\n\n  const { rows } = await query(\n    \"INSERT INTO customers (name,email,phone) VALUES ($1,$2,$3) RETURNING *\",\n    [name, email, phone]\n  );\n\n  if (expectsJson(req)) {\n    return NextResponse.json(rows[0]);\n  }\n\n  return NextResponse.redirect(new URL(\"/pelanggan\", req.url));\n}\n\nexport async function GET(req: NextRequest) {\n  const q = req.nextUrl.searchParams.get(\"q\")?.trim() ?? \"\";\n  const keyword = q ? `%${q}%` : \"%%\";\n  const { rows } = await query(\n    `\n    SELECT *\n    FROM customers\n    WHERE name ILIKE $1 OR COALESCE(email,'') ILIKE $1 OR COALESCE(phone,'') ILIKE $1\n    ORDER BY created_at DESC\n  `,\n    [keyword]\n  );\n  return NextResponse.json(rows);\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,MAAM,cAAc,CAAC,MACnB,IAAI,OAAO,CAAC,GAAG,CAAC,wBAAwB;AAEnC,eAAe,KAAK,GAAgB;IACzC,MAAM,OAAO,MAAM,IAAI,QAAQ;IAC/B,MAAM,OAAO,OAAO,KAAK,GAAG,CAAC,WAAW,IAAI,IAAI;IAChD,MAAM,QAAQ,KAAK,GAAG,CAAC,WACnB,OAAO,KAAK,GAAG,CAAC,UAAU,IAAI,MAAM,OACpC;IACJ,MAAM,QAAQ,KAAK,GAAG,CAAC,WACnB,OAAO,KAAK,GAAG,CAAC,UAAU,IAAI,MAAM,OACpC;IAEJ,IAAI,CAAC,MAAM;QACT,MAAM,UAAU;QAChB,IAAI,YAAY,MAAM;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAAS,OAAO;YAAO,GAAG;gBAAE,QAAQ;YAAI;QAC5E;QACA,MAAM,cAAc,IAAI,IAAI,kCAAkC,IAAI,GAAG;QACrE,OAAO,gJAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,IAAI,SAAS,CAAC,MAAM,QAAQ,CAAC,MAAM;QACjC,MAAM,UAAU;QAChB,IAAI,YAAY,MAAM;YACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAAS,OAAO;YAAQ,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QACA,MAAM,cAAc,IAAI,IAAI,kCAAkC,IAAI,GAAG;QACrE,OAAO,gJAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,IAAI,OAAO;QACT,MAAM,EAAE,MAAM,GAAG,EAAE,GAAG,MAAM,IAAA,2HAAK,EAC/B,qDACA;YAAC;SAAM;QAET,IAAI,IAAI,MAAM,GAAG,GAAG;YAClB,MAAM,UAAU;YAClB,IAAI,YAAY,MAAM;gBACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;oBAAS,OAAO;gBAAQ,GAAG;oBAAE,QAAQ;gBAAI;YAC7E;YACE,MAAM,cAAc,IAAI,IACtB,gCACA,IAAI,GAAG;YAET,OAAO,gJAAY,CAAC,QAAQ,CAAC;QAC/B;IACF;IAEA,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,IAAA,2HAAK,EAC1B,0EACA;QAAC;QAAM;QAAO;KAAM;IAGtB,IAAI,YAAY,MAAM;QACpB,OAAO,gJAAY,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;IAClC;IAEA,OAAO,gJAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,cAAc,IAAI,GAAG;AAC5D;AAEO,eAAe,IAAI,GAAgB;IACxC,MAAM,IAAI,IAAI,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,UAAU;IACvD,MAAM,UAAU,IAAI,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG;IAC/B,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,IAAA,2HAAK,EAC1B,CAAC;;;;;EAKH,CAAC,EACC;QAAC;KAAQ;IAEX,OAAO,gJAAY,CAAC,IAAI,CAAC;AAC3B","debugId":null}}]
}