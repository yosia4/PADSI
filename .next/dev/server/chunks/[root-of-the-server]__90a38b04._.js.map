{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/lib/db.ts"],"sourcesContent":["import { Pool } from \"pg\";\n\nlet pool: Pool | null = null;\n\nfunction getPool() {\n  if (!pool) {\n    pool = new Pool({\n      connectionString: process.env.DATABASE_URL,\n      ssl: {\n        rejectUnauthorized: false,\n      },\n    });\n  }\n  return pool;\n}\n\nexport async function query<T = any>(\n  text: string,\n  params?: any[]\n): Promise<{ rows: T[] }> {\n  const p = getPool();\n  const res = await p.query(text, params);\n  return res as any;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,OAAoB;AAExB,SAAS;IACP,IAAI,CAAC,MAAM;QACT,OAAO,IAAI,qGAAI,CAAC;YACd,kBAAkB,QAAQ,GAAG,CAAC,YAAY;YAC1C,KAAK;gBACH,oBAAoB;YACtB;QACF;IACF;IACA,OAAO;AACT;AAEO,eAAe,MACpB,IAAY,EACZ,MAAc;IAEd,MAAM,IAAI;IACV,MAAM,MAAM,MAAM,EAAE,KAAK,CAAC,MAAM;IAChC,OAAO;AACT","debugId":null}},
    {"offset": {"line": 85, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/lib/session.ts"],"sourcesContent":["// ✅ Hanya untuk SERVER COMPONENT\nimport \"server-only\";\nimport { cookies } from \"next/headers\";\nimport { randomUUID } from \"crypto\";\nimport { query } from \"./db\";\n\nconst COOKIE = process.env.SESSION_COOKIE_NAME || \"padsi_session\";\nconst SESSION_TTL_MS = 2 * 24 * 60 * 60 * 1000; // 2 hari\n\n/**\n * Membuat sesi login baru\n */\nexport async function createSession(userId: number) {\n  const sid = randomUUID();\n  const exp = new Date(Date.now() + SESSION_TTL_MS);\n\n  // hapus sesi lama supaya tidak ada token usang ketika role berubah\n  await query(\"DELETE FROM sessions WHERE user_id = $1\", [userId]);\n\n  await query(\n    \"INSERT INTO sessions (session_id, user_id, expires_at) VALUES ($1, $2, $3)\",\n    [sid, userId, exp]\n  );\n\n  // ✅ Sekarang cookies() harus di-await\n  const cookieStore = await cookies();\n  const isProd = process.env.NODE_ENV === \"production\";\n  cookieStore.set(COOKIE, sid, {\n    httpOnly: true,\n    sameSite: \"lax\",\n    path: \"/\",\n    secure: isProd,\n    expires: exp,\n  });\n}\n\n/**\n * Menghapus sesi login (logout)\n */\nexport async function destroySession() {\n  const cookieStore = await cookies();\n  const c = cookieStore.get(COOKIE);\n  if (c?.value) {\n    await query(\"DELETE FROM sessions WHERE session_id = $1\", [c.value]);\n    cookieStore.delete(COOKIE);\n  }\n}\n\n/**\n * Mendapatkan data user dari sesi aktif\n */\nexport async function getSessionUser() {\n  const cookieStore = await cookies();\n  const c = cookieStore.get(COOKIE);\n  if (!c?.value) return null;\n\n  await query(\"ALTER TABLE users ADD COLUMN IF NOT EXISTS avatar_data TEXT\");\n\n  const { rows } = await query(\n    `\n    SELECT u.id, u.email, u.name, u.role, u.avatar_data\n    FROM sessions s\n    JOIN users u ON u.id = s.user_id\n    WHERE s.session_id = $1\n      AND s.expires_at > NOW()\n  `,\n    [c.value]\n  );\n\n  return rows[0] || null;\n}\n\n/**\n * Mengecek apakah user punya role tertentu\n */\nexport async function requireRole(roles: (\"OWNER\" | \"PEGAWAI\")[]) {\n  const user = await getSessionUser();\n  if (!user) return { ok: false as const, user: null };\n  if (!roles.includes(user.role)) return { ok: false as const, user };\n  return { ok: true as const, user };\n}\n"],"names":[],"mappings":"AAAA,iCAAiC;;;;;;;;;;;AACjC;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,mBAAmB,IAAI;AAClD,MAAM,iBAAiB,IAAI,KAAK,KAAK,KAAK,MAAM,SAAS;AAKlD,eAAe,cAAc,MAAc;IAChD,MAAM,MAAM,IAAA,mHAAU;IACtB,MAAM,MAAM,IAAI,KAAK,KAAK,GAAG,KAAK;IAElC,mEAAmE;IACnE,MAAM,IAAA,2HAAK,EAAC,2CAA2C;QAAC;KAAO;IAE/D,MAAM,IAAA,2HAAK,EACT,8EACA;QAAC;QAAK;QAAQ;KAAI;IAGpB,sCAAsC;IACtC,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,SAAS,oDAAyB;IACxC,YAAY,GAAG,CAAC,QAAQ,KAAK;QAC3B,UAAU;QACV,UAAU;QACV,MAAM;QACN,QAAQ;QACR,SAAS;IACX;AACF;AAKO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,IAAI,YAAY,GAAG,CAAC;IAC1B,IAAI,GAAG,OAAO;QACZ,MAAM,IAAA,2HAAK,EAAC,8CAA8C;YAAC,EAAE,KAAK;SAAC;QACnE,YAAY,MAAM,CAAC;IACrB;AACF;AAKO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,IAAI,YAAY,GAAG,CAAC;IAC1B,IAAI,CAAC,GAAG,OAAO,OAAO;IAEtB,MAAM,IAAA,2HAAK,EAAC;IAEZ,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,IAAA,2HAAK,EAC1B,CAAC;;;;;;EAMH,CAAC,EACC;QAAC,EAAE,KAAK;KAAC;IAGX,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAKO,eAAe,YAAY,KAA8B;IAC9D,MAAM,OAAO,MAAM;IACnB,IAAI,CAAC,MAAM,OAAO;QAAE,IAAI;QAAgB,MAAM;IAAK;IACnD,IAAI,CAAC,MAAM,QAAQ,CAAC,KAAK,IAAI,GAAG,OAAO;QAAE,IAAI;QAAgB;IAAK;IAClE,OAAO;QAAE,IAAI;QAAe;IAAK;AACnC","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///D:/Proyek%20PADSI/PADSI-KEOS/src/app/api/login/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport { query } from \"@/lib/db\";\nimport { createSession } from \"@/lib/session\";\nimport { randomBytes, scryptSync, timingSafeEqual } from \"crypto\";\n\ntype Attempt = { count: number; expiresAt: number };\nconst attempts = new Map<string, Attempt>();\nconst RATE_LIMIT_WINDOW_MS = 10 * 60 * 1000;\nconst RATE_LIMIT_MAX = 5;\n\nfunction getClientKey(req: NextRequest) {\n  return (\n    req.ip ||\n    req.headers.get(\"x-forwarded-for\") ||\n    req.headers.get(\"x-real-ip\") ||\n    \"unknown\"\n  );\n}\n\nfunction isBlocked(key: string) {\n  const info = attempts.get(key);\n  if (!info) return false;\n  if (Date.now() > info.expiresAt) {\n    attempts.delete(key);\n    return false;\n  }\n  return info.count >= RATE_LIMIT_MAX;\n}\n\nfunction recordFailedAttempt(key: string) {\n  const now = Date.now();\n  const info = attempts.get(key);\n  if (!info || now > info.expiresAt) {\n    attempts.set(key, { count: 1, expiresAt: now + RATE_LIMIT_WINDOW_MS });\n  } else {\n    info.count += 1;\n    attempts.set(key, info);\n  }\n}\n\nfunction clearAttempts(key: string) {\n  attempts.delete(key);\n}\n\nfunction hashPassword(password: string) {\n  const salt = randomBytes(16).toString(\"hex\");\n  const hash = scryptSync(password, salt, 64).toString(\"hex\");\n  return `${salt}:${hash}`;\n}\n\nfunction verifyPassword(plain: string, stored: string) {\n  if (!stored.includes(\":\")) {\n    return plain === stored;\n  }\n\n  const [salt, originalHash] = stored.split(\":\");\n  const hashedBuffer = Buffer.from(originalHash, \"hex\");\n  const derived = scryptSync(plain, salt, 64);\n\n  if (hashedBuffer.length !== derived.length) return false;\n  return timingSafeEqual(derived, hashedBuffer);\n}\n\nexport async function POST(req: NextRequest) {\n  const form = await req.formData();\n  const rawEmail = String(form.get(\"email\") || \"\").trim();\n  const email = rawEmail.toLowerCase();\n  const password = String(form.get(\"password\") || \"\");\n  const clientKey = getClientKey(req);\n\n  if (!rawEmail) {\n    return NextResponse.redirect(new URL(\"/login?error=email_empty\", req.url));\n  }\n  if (!password) {\n    return NextResponse.redirect(\n      new URL(\"/login?error=password_empty\", req.url)\n    );\n  }\n\n  if (isBlocked(clientKey)) {\n    return NextResponse.redirect(new URL(\"/login?error=rate\", req.url));\n  }\n\n  const { rows } = await query(\n    \"SELECT id, email, name, role, password FROM users WHERE LOWER(email)=$1\",\n    [email]\n  );\n  const user = (rows as any)[0];\n\n  if (!user || !verifyPassword(password, user.password)) {\n    recordFailedAttempt(clientKey);\n    const err = !user ? \"email_invalid\" : \"password_invalid\";\n    return NextResponse.redirect(new URL(`/login?error=${err}`, req.url));\n  }\n\n  // upgrade hash jika masih plaintext\n  if (!user.password.includes(\":\")) {\n    const newHash = hashPassword(password);\n    await query(\"UPDATE users SET password=$1 WHERE id=$2\", [newHash, user.id]);\n  }\n\n  clearAttempts(clientKey);\n  await createSession(user.id);\n  return NextResponse.redirect(new URL(\"/dashboard\", req.url));\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}